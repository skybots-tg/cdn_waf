{% extends "base.html" %}

{% block title %}Управление нодой {{ node.name }} - FlareCloud{% endblock %}

{% block content %}
<div class="container" style="padding: 32px 24px;">
    <!-- Header -->
    <div class="flex-between mb-4">
        <div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <a href="/edge-nodes" style="color: var(--text-secondary); text-decoration: none;">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 style="font-size: 32px; font-weight: 700;">{{ node.name }}</h1>
                <span class="badge badge-{{ 'success' if node.status == 'active' else 'warning' }}">
                    {{ node.status }}
                </span>
            </div>
            <p style="color: var(--text-secondary); font-size: 14px;">
                ID: {{ node.id }} &bull; IP: {{ node.ip_address }} &bull; {{ node.location }}
            </p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="checkConnection()">
                <i class="fas fa-plug"></i> Проверить связь
            </button>
            <button class="btn btn-primary" onclick="saveSettings()">
                <i class="fas fa-save"></i> Сохранить
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs mb-4">
        <button class="tab-link active" onclick="switchTab('settings')">
            <i class="fas fa-cog"></i> Настройки
        </button>
        <button class="tab-link" onclick="switchTab('nginx')">
            <i class="fas fa-server"></i> Nginx правила
        </button>
        <button class="tab-link" onclick="switchTab('components')">
            <i class="fas fa-boxes"></i> Компоненты
        </button>
        <button class="tab-link" onclick="switchTab('logs')">
            <i class="fas fa-terminal"></i> Логи
        </button>
    </div>

    <!-- Tab Content: Settings -->
    <div id="tab-settings" class="tab-content">
        <div class="grid grid-2 gap-3">
            <!-- Basic Info -->
            <div class="glass-card">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">
                    <i class="fas fa-info-circle"></i> Основная информация
                </h3>
                <form id="node-settings-form">
                    <div class="form-group">
                        <label class="form-label">Название ноды</label>
                        <input type="text" class="form-input" name="name" value="{{ node.name }}">
                    </div>
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label class="form-label">IPv4 Адрес</label>
                            <input type="text" class="form-input" name="ip_address" value="{{ node.ip_address }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">IPv6 Адрес (опционально)</label>
                            <input type="text" class="form-input" name="ipv6_address" value="{{ node.ipv6_address or '' }}">
                        </div>
                    </div>
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label class="form-label">Код локации</label>
                            <input type="text" class="form-input" name="location_code" value="{{ node.location_code or 'RU-MSK' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Датацентр</label>
                            <input type="text" class="form-input" name="datacenter" value="{{ node.datacenter or '' }}">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="flex-between" style="cursor: pointer;">
                            <span>Активна</span>
                            <div class="toggle-switch">
                                <input type="checkbox" name="enabled" {% if node.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                    </div>
                </form>
            </div>

            <!-- Edge Node Configuration -->
            <div class="glass-card">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">
                    <i class="fas fa-network-wired"></i> Конфигурация Edge Node
                </h3>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                    Параметры для подключения ноды к Control Plane (config.yaml).
                </p>
                <div class="form-group">
                    <label class="form-label">Control Plane URL</label>
                    <div class="input-group">
                        <input type="text" class="form-input" value="{{ control_plane_url }}" id="cp-url" placeholder="https://control.example.com">
                        <button class="btn btn-secondary" onclick="copyToClipboard('cp-url')" type="button" title="Копировать">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top: 4px;">
                        Этот URL будет записан в config.yaml при установке агента. Если он некорректен, измените его перед установкой.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <div class="input-group">
                        <input type="text" class="form-input" value="{{ node.api_key or '' }}" readonly id="api-key" style="font-family: monospace;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('api-key')" type="button">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-warning" onclick="regenerateApiKey()" type="button" title="Сгенерировать новый ключ">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    {% if not node.api_key %}
                    <p style="color: var(--warning); font-size: 12px; margin-top: 4px;">
                        API ключ не задан. Сгенерируйте новый ключ для работы ноды.
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- SSH Configuration -->
            <div class="glass-card">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">
                    <i class="fas fa-key"></i> SSH Доступ
                </h3>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                    Необходимо для автоматической установки компонентов.
                </p>
                <form id="ssh-settings-form">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label class="form-label">SSH Хост (если отличается от IP)</label>
                            <input type="text" class="form-input" name="ssh_host" value="{{ node.ssh_host or node.ip_address }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">SSH Порт</label>
                            <input type="number" class="form-input" name="ssh_port" value="{{ node.ssh_port or 22 }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Пользователь (root)</label>
                        <input type="text" class="form-input" name="ssh_user" value="{{ node.ssh_user or 'root' }}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSH Private Key (оставьте пустым для входа по паролю)</label>
                        <textarea class="form-textarea" name="ssh_key" style="font-family: monospace; font-size: 12px; height: 100px;" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----...">{{ node.ssh_key or '' }}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SSH Пароль (если не используется ключ)</label>
                        <input type="password" class="form-input" name="ssh_password" placeholder="••••••••" value="">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            Оставьте пустым, чтобы не менять.
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tab Content: Nginx Rules -->
    <div id="tab-nginx" class="tab-content" style="display: none;">
        <div class="glass-card mb-4">
            <div class="flex-between">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600;">
                        <i class="fas fa-sliders-h"></i> Конфигурация Nginx
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">
                        Управление правилами веб-сервера, лимитами и протоколами
                    </p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="resetNginxRules()">
                        <i class="fas fa-undo"></i> Сбросить
                    </button>
                    <button class="btn btn-secondary" onclick="testNginxRules()">
                        <i class="fas fa-check-circle"></i> Тест
                    </button>
                    <button class="btn btn-primary" onclick="applyNginxRules()">
                        <i class="fas fa-save"></i> Применить
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-2 gap-3">
            <!-- Client Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon"><i class="fas fa-upload"></i></div>
                    <div>
                        <h4>Клиентские лимиты</h4>
                        <p>Размеры запросов и таймауты</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        Максимальный размер тела запроса
                        <span class="hint">(client_max_body_size)</span>
                    </label>
                    <div class="input-with-unit">
                        <input type="text" class="form-input" id="nginx-client-max-body-size" value="100m" placeholder="100m">
                        <span class="unit-hint">m = МБ, g = ГБ</span>
                    </div>
                    <p class="form-hint">Максимальный размер загружаемых файлов. Например: 100m, 1g</p>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Таймаут тела запроса (сек)</label>
                        <input type="number" class="form-input" id="nginx-client-body-timeout" value="60" min="1" max="3600">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Таймаут заголовков (сек)</label>
                        <input type="number" class="form-input" id="nginx-client-header-timeout" value="60" min="1" max="3600">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Буфер тела запроса</label>
                    <input type="text" class="form-input" id="nginx-client-body-buffer-size" value="128k" placeholder="128k">
                </div>
            </div>

            <!-- WebSocket Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon ws-icon"><i class="fas fa-plug"></i></div>
                    <div>
                        <h4>WebSocket</h4>
                        <p>Поддержка двунаправленной связи</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span style="font-weight: 500;">Включить WebSocket</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-ws-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                    <p class="form-hint">Добавляет заголовки Upgrade и Connection для WS соединений</p>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Таймаут чтения (сек)</label>
                        <input type="number" class="form-input" id="nginx-ws-read-timeout" value="3600" min="1" max="86400">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Таймаут отправки (сек)</label>
                        <input type="number" class="form-input" id="nginx-ws-send-timeout" value="3600" min="1" max="86400">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Таймаут подключения (сек)</label>
                    <input type="number" class="form-input" id="nginx-ws-connect-timeout" value="60" min="1" max="300">
                </div>
            </div>

            <!-- Proxy Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon proxy-icon"><i class="fas fa-exchange-alt"></i></div>
                    <div>
                        <h4>Проксирование</h4>
                        <p>Настройки связи с backend</p>
                    </div>
                </div>
                <div class="grid grid-3 gap-2">
                    <div class="form-group">
                        <label class="form-label">Connect (сек)</label>
                        <input type="number" class="form-input" id="nginx-proxy-connect-timeout" value="60" min="1" max="300">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Send (сек)</label>
                        <input type="number" class="form-input" id="nginx-proxy-send-timeout" value="60" min="1" max="3600">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Read (сек)</label>
                        <input type="number" class="form-input" id="nginx-proxy-read-timeout" value="60" min="1" max="3600">
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Размер буфера</label>
                        <input type="text" class="form-input" id="nginx-proxy-buffer-size" value="4k" placeholder="4k">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Буферы (кол-во × размер)</label>
                        <input type="text" class="form-input" id="nginx-proxy-buffers" value="8 4k" placeholder="8 4k">
                    </div>
                </div>
            </div>

            <!-- Gzip Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon gzip-icon"><i class="fas fa-compress-alt"></i></div>
                    <div>
                        <h4>Сжатие (Gzip)</h4>
                        <p>Уменьшение размера ответов</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span style="font-weight: 500;">Включить Gzip</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-gzip-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Уровень сжатия (1-9)</label>
                        <input type="range" class="form-range" id="nginx-gzip-level" min="1" max="9" value="6">
                        <div class="range-labels">
                            <span>Быстро</span>
                            <span id="gzip-level-value">6</span>
                            <span>Сильно</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Мин. размер (байт)</label>
                        <input type="number" class="form-input" id="nginx-gzip-min-length" value="1000" min="0">
                    </div>
                </div>
            </div>

            <!-- Keepalive Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon keepalive-icon"><i class="fas fa-heartbeat"></i></div>
                    <div>
                        <h4>Keepalive</h4>
                        <p>Постоянные соединения</p>
                    </div>
                </div>
                <div class="grid grid-3 gap-2">
                    <div class="form-group">
                        <label class="form-label">Таймаут (сек)</label>
                        <input type="number" class="form-input" id="nginx-keepalive-timeout" value="65" min="0" max="3600">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Макс. запросов</label>
                        <input type="number" class="form-input" id="nginx-keepalive-requests" value="1000" min="0" max="100000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Upstream conn.</label>
                        <input type="number" class="form-input" id="nginx-keepalive-upstream" value="32" min="0" max="1000">
                    </div>
                </div>
            </div>

            <!-- HTTP/2 Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon http2-icon"><i class="fas fa-bolt"></i></div>
                    <div>
                        <h4>HTTP/2</h4>
                        <p>Современный протокол</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span style="font-weight: 500;">Включить HTTP/2</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-http2-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Макс. параллельных потоков</label>
                    <input type="number" class="form-input" id="nginx-http2-streams" value="128" min="1" max="1000">
                </div>
            </div>

            <!-- Rate Limiting -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon rate-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div>
                        <h4>Лимит запросов</h4>
                        <p>Защита от перегрузки</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span style="font-weight: 500;">Включить Rate Limiting</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-rate-enabled">
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Лимит (r/s или r/m)</label>
                        <input type="text" class="form-input" id="nginx-rate-limit" value="100r/s" placeholder="100r/s">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Burst (всплеск)</label>
                        <input type="number" class="form-input" id="nginx-rate-burst" value="200" min="0">
                    </div>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon security-icon"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <h4>Безопасность</h4>
                        <p>Заголовки и защита</p>
                    </div>
                </div>
                <div class="security-toggles">
                    <label class="security-toggle">
                        <input type="checkbox" id="nginx-hide-version" checked>
                        <span>Скрывать версию Nginx</span>
                    </label>
                    <label class="security-toggle">
                        <input type="checkbox" id="nginx-x-frame-options" checked>
                        <span>X-Frame-Options (защита от clickjacking)</span>
                    </label>
                    <label class="security-toggle">
                        <input type="checkbox" id="nginx-x-content-type" checked>
                        <span>X-Content-Type-Options (nosniff)</span>
                    </label>
                    <label class="security-toggle">
                        <input type="checkbox" id="nginx-x-xss" checked>
                        <span>X-XSS-Protection</span>
                    </label>
                </div>
            </div>

            <!-- SSL Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon ssl-icon"><i class="fas fa-lock"></i></div>
                    <div>
                        <h4>SSL/TLS</h4>
                        <p>Шифрование соединений</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Протоколы TLS</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="nginx-tls12" checked> TLSv1.2
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="nginx-tls13" checked> TLSv1.3
                        </label>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span>OCSP Stapling</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-ocsp-stapling" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Таймаут сессии</label>
                    <input type="text" class="form-input" id="nginx-ssl-session-timeout" value="1d" placeholder="1d">
                </div>
            </div>

            <!-- Cache Settings -->
            <div class="glass-card nginx-section">
                <div class="section-header">
                    <div class="section-icon cache-icon"><i class="fas fa-database"></i></div>
                    <div>
                        <h4>Кэширование</h4>
                        <p>Proxy cache для ускорения</p>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="flex-between" style="cursor: pointer;">
                        <span style="font-weight: 500;">Включить кэш</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="nginx-cache-enabled" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Макс. размер кэша</label>
                        <input type="text" class="form-input" id="nginx-cache-max-size" value="10g" placeholder="10g">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Время неактивности</label>
                        <input type="text" class="form-input" id="nginx-cache-inactive" value="7d" placeholder="7d">
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Preview -->
        <div class="glass-card mt-4">
            <div class="flex-between mb-3">
                <h3 style="font-size: 16px; font-weight: 600;">
                    <i class="fas fa-code"></i> Предпросмотр конфигурации
                </h3>
                <button class="btn btn-sm btn-secondary" onclick="previewNginxConfig()">
                    <i class="fas fa-eye"></i> Показать
                </button>
            </div>
            <pre class="config-preview" id="nginx-config-preview" style="display: none;"></pre>
        </div>
    </div>

    <!-- Tab Content: Components -->
    <div id="tab-components" class="tab-content" style="display: none;">
        <div class="glass-card mb-4">
            <div class="flex-between">
                <div>
                    <h3 style="font-size: 18px; font-weight: 600;">Состояние компонентов</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">Управление программным обеспечением на ноде</p>
                </div>
                <button class="btn btn-primary" onclick="installAll()">
                    <i class="fas fa-sync-alt"></i> Полная установка (Все)
                </button>
            </div>
        </div>

        <div class="grid grid-2 gap-3">
            <!-- System -->
            <div class="glass-card" id="card-system">
                <div class="flex-between mb-3">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="component-icon"><i class="fab fa-linux"></i></div>
                        <div>
                            <h4 style="font-weight: 600;">System Dependencies</h4>
                            <span class="status-dot status-warning"></span> <span class="status-text" style="font-size: 12px; color: var(--text-muted);">Checking...</span>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-secondary" onclick="runAction('install_deps')">Переустановить</button>
                    </div>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Базовые пакеты: curl, git, build-essential, python3-dev, python3-venv
                </p>
            </div>

            <!-- Nginx -->
            <div class="glass-card" id="card-nginx">
                <div class="flex-between mb-3">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="component-icon"><i class="fas fa-server"></i></div>
                        <div>
                            <h4 style="font-weight: 600;">Nginx & Modules</h4>
                            <span class="status-dot status-warning"></span> <span class="status-text" style="font-size: 12px; color: var(--text-muted);">Checking...</span>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="runAction('reload_nginx')">Reload</button>
                        <button class="btn btn-sm btn-secondary" onclick="runAction('install_nginx')">Install</button>
                    </div>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Веб-сервер и WAF модули.
                </p>
            </div>

            <!-- Python Env -->
            <div class="glass-card" id="card-python">
                <div class="flex-between mb-3">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="component-icon"><i class="fab fa-python"></i></div>
                        <div>
                            <h4 style="font-weight: 600;">Python Environment</h4>
                            <span class="status-dot status-warning"></span> <span class="status-text" style="font-size: 12px; color: var(--text-muted);">Checking...</span>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="runAction('install_python')">Install</button>
                        <button class="btn btn-sm btn-secondary" onclick="runAction('update_python')">Update</button>
                    </div>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Виртуальное окружение и зависимости приложения (/opt/cdn_waf/venv)
                </p>
            </div>

            <!-- Agent -->
            <div class="glass-card" id="card-agent">
                <div class="flex-between mb-3">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="component-icon"><i class="fas fa-robot"></i></div>
                        <div>
                            <h4 style="font-weight: 600;">Edge Agent (cdn-waf-agent)</h4>
                            <span class="status-dot status-warning"></span> <span class="status-text" style="font-size: 12px; color: var(--text-muted);">Checking...</span>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-primary" onclick="runAction('install_agent')">Install</button>
                        <button class="btn btn-sm btn-secondary" onclick="runAction('restart_agent')">Restart</button>
                        <button class="btn btn-sm btn-secondary" onclick="runAction('update_agent')">Update</button>
                    </div>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Служба синхронизации конфигураций и отправки логов. Требует настроенного API ключа.
                </p>
            </div>
            
            <!-- SSL -->
            <div class="glass-card" id="card-certbot">
                <div class="flex-between mb-3">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="component-icon"><i class="fas fa-lock"></i></div>
                        <div>
                            <h4 style="font-weight: 600;">Certbot & SSL</h4>
                            <span class="status-dot status-warning"></span> <span class="status-text" style="font-size: 12px; color: var(--text-muted);">Checking...</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="runAction('install_certbot')">Install</button>
                </div>
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Инструменты для выпуска Let's Encrypt сертификатов
                </p>
            </div>
        </div>
    </div>

    <!-- Tab Content: Logs -->
    <div id="tab-logs" class="tab-content" style="display: none;">
        <div class="glass-card">
            <div class="flex-between mb-3">
                <h3 style="font-size: 18px; font-weight: 600;">Терминал установки</h3>
                <button class="btn btn-sm btn-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Очистить
                </button>
            </div>
            <div class="terminal-window" id="install-logs">
                <div class="terminal-line"><span class="terminal-prompt">$</span> ready to connect...</div>
            </div>
        </div>
    </div>

</div>

<style>
.tabs {
    display: flex;
    gap: 12px;
    border-bottom: 1px solid var(--glass-border);
    padding-bottom: 12px;
}

.tab-link {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    padding: 8px 16px;
    cursor: pointer;
    border-radius: var(--border-radius-sm);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-link:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.tab-link.active {
    color: var(--accent-primary);
    background: var(--accent-light);
}

.component-icon {
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    font-size: 20px;
}

.status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
}

.status-success { background: var(--success); box-shadow: 0 0 8px rgba(81, 207, 102, 0.4); }
.status-warning { background: var(--warning); box-shadow: 0 0 8px rgba(255, 212, 59, 0.4); }
.status-error { background: var(--error); box-shadow: 0 0 8px rgba(255, 107, 107, 0.4); }

.terminal-window {
    background: #1e1e1e;
    color: #f0f0f0;
    font-family: 'Consolas', 'Monaco', monospace;
    padding: 16px;
    border-radius: 8px;
    height: 400px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.5;
}

.terminal-line { margin-bottom: 4px; }
.terminal-prompt { color: var(--success); margin-right: 8px; }
.terminal-info { color: var(--info); }
.terminal-error { color: var(--error); }
.terminal-success { color: var(--success); }

.input-group {
    display: flex;
    gap: 8px;
}
.input-group .form-input {
    flex: 1;
}

/* Nginx Rules Tab Styles */
.nginx-section .section-header {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--glass-border);
}

.nginx-section .section-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    background: linear-gradient(135deg, var(--accent-light), transparent);
    color: var(--accent-primary);
    flex-shrink: 0;
}

.nginx-section .section-header h4 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
}

.nginx-section .section-header p {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
}

/* Different icon colors */
.ws-icon { background: linear-gradient(135deg, rgba(51, 154, 240, 0.15), transparent) !important; color: var(--info) !important; }
.proxy-icon { background: linear-gradient(135deg, rgba(156, 39, 176, 0.15), transparent) !important; color: #9c27b0 !important; }
.gzip-icon { background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), transparent) !important; color: #4caf50 !important; }
.keepalive-icon { background: linear-gradient(135deg, rgba(233, 30, 99, 0.15), transparent) !important; color: #e91e63 !important; }
.http2-icon { background: linear-gradient(135deg, rgba(255, 152, 0, 0.15), transparent) !important; color: #ff9800 !important; }
.rate-icon { background: linear-gradient(135deg, rgba(255, 87, 34, 0.15), transparent) !important; color: #ff5722 !important; }
.security-icon { background: linear-gradient(135deg, rgba(0, 150, 136, 0.15), transparent) !important; color: #009688 !important; }
.ssl-icon { background: linear-gradient(135deg, rgba(33, 150, 243, 0.15), transparent) !important; color: #2196f3 !important; }
.cache-icon { background: linear-gradient(135deg, rgba(121, 85, 72, 0.15), transparent) !important; color: #795548 !important; }

.form-hint {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.hint {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 400;
    margin-left: 4px;
}

.input-with-unit {
    display: flex;
    align-items: center;
    gap: 8px;
}

.input-with-unit .form-input {
    flex: 1;
}

.unit-hint {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
}

.form-range {
    width: 100%;
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    margin-top: 8px;
}

.form-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--accent-primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.3);
}

.range-labels {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

.range-labels span:nth-child(2) {
    font-weight: 600;
    color: var(--accent-primary);
    font-size: 14px;
}

.security-toggles {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.security-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    font-size: 14px;
}

.security-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--accent-primary);
    cursor: pointer;
}

.checkbox-group {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
}

.checkbox-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent-primary);
}

.config-preview {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 16px;
    border-radius: 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    line-height: 1.5;
    overflow-x: auto;
    max-height: 400px;
    white-space: pre;
}

.grid-3 {
    grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 768px) {
    .grid-3 {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
const NODE_ID = {{ node.id }};
</script>
<script src="/static/js/nginx_rules.js"></script>
<script>
// ============================================
// Page Functions
// ============================================

function copyToClipboard(elementId) {
    const el = document.getElementById(elementId);
    el.select();
    el.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(el.value).then(() => {
        showNotification('Скопировано в буфер обмена', 'success');
    }).catch(err => {
        showNotification('Не удалось скопировать', 'error');
    });
}

async function regenerateApiKey() {
    if (!confirm('Вы уверены, что хотите сгенерировать новый API ключ? Старый ключ перестанет работать, и вам придется обновить конфигурацию на ноде.')) {
        return;
    }
    
    showNotification('Генерация ключа...', 'info');
    try {
        const response = await api.post(`/edge-nodes/${NODE_ID}/regenerate-api-key`);
        if (response.api_key) {
            document.getElementById('api-key').value = response.api_key;
            showNotification('Новый API ключ сгенерирован', 'success');
        } else {
             showNotification('Ошибка генерации ключа', 'error');
        }
    } catch (error) {
        showNotification(`Ошибка: ${error.message}`, 'error');
    }
}

function switchTab(tabName) {
    // Hide all contents
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    // Deactivate all buttons
    document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
    
    // Show selected
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    // Activate button (simple matching by index or text, but here manual is fine)
    const btn = Array.from(document.querySelectorAll('.tab-link')).find(b => b.onclick.toString().includes(tabName));
    if (btn) btn.classList.add('active');
}

async function saveSettings() {
    const form = document.getElementById('node-settings-form');
    const sshForm = document.getElementById('ssh-settings-form');
    
    const data = {
        ...Object.fromEntries(new FormData(form)),
        ...Object.fromEntries(new FormData(sshForm))
    };
    
    // Convert checkbox
    data.enabled = form.querySelector('[name="enabled"]').checked;
    
    showNotification('Сохранение настроек...', 'info');
    
    try {
        await api.patch(`/edge-nodes/${NODE_ID}`, data);
        showNotification('Настройки сохранены', 'success');
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

function log(message, type = 'normal') {
    const term = document.getElementById('install-logs');
    const line = document.createElement('div');
    line.className = 'terminal-line';
    
    let content = `<span class="terminal-prompt">></span> `;
    
    if (type === 'error') {
        content += `<span class="terminal-error">${escapeHtml(message)}</span>`;
    } else if (type === 'success') {
        content += `<span class="terminal-success">${escapeHtml(message)}</span>`;
    } else if (type === 'info') {
        content += `<span class="terminal-info">${escapeHtml(message)}</span>`;
    } else if (message && message.includes && message.includes('\n')) {
        // Handle multiline output
        content += `<pre style="margin: 0; white-space: pre-wrap; font-family: inherit;">${escapeHtml(message)}</pre>`;
    } else {
        content += escapeHtml(message);
    }
    
    line.innerHTML = content;
    term.appendChild(line);
    term.scrollTop = term.scrollHeight;
}

function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function clearLogs() {
    document.getElementById('install-logs').innerHTML = '<div class="terminal-line"><span class="terminal-prompt">$</span> cleared</div>';
}

async function runAction(action) {
    switchTab('logs');
    log(`Запуск действия: ${action}...`, 'info');
    
    let component = '';
    let cmd = '';
    
    // Map action to component/command
    // Handle specific action names first
    if (action === 'install_deps') {
        component = 'system';
        cmd = 'install';
    } else if (action === 'install_nginx') {
        component = 'nginx';
        cmd = 'install';
    } else if (action === 'reload_nginx') {
        component = 'nginx';
        cmd = 'reload';
    } else if (action === 'install_certbot') {
        component = 'certbot';
        cmd = 'install';
    } else if (action === 'install_python' || action === 'update_python') {
        component = 'python';
        cmd = 'install';  // Python uses 'install' to create/update venv
    } else if (action === 'install_agent') {
        component = 'agent';
        cmd = 'install';
    } else if (action === 'update_agent') {
        component = 'agent';
        cmd = 'update';
    } else if (action === 'restart_agent') {
        component = 'agent';
        cmd = 'restart';
    } else {
        // Fallback for generic patterns
        if (action.includes('nginx')) component = 'nginx';
        else if (action.includes('certbot')) component = 'certbot';
        else if (action.includes('python')) component = 'python';
        else if (action.includes('agent')) component = 'agent';
        
        if (action.startsWith('install_')) cmd = 'install';
        else if (action.startsWith('reload_')) cmd = 'reload';
        else if (action.startsWith('restart_')) cmd = 'restart';
        else if (action.startsWith('update_')) cmd = 'update';
        else cmd = action;
    }

    const params = {};
    if (component === 'agent') {
        // Pass the Control Plane URL from the input
        const cpUrl = document.getElementById('cp-url').value;
        if (cpUrl) {
            params.control_plane_url = cpUrl;
        }
    }

    try {
        log(`Sending command to node: ${component} ${cmd}...`);
        
        // Call real API
        const response = await api.post(`/edge-nodes/${NODE_ID}/component`, {
            component: component,
            action: cmd,
            params: params
        });
        
        // Check if this is an async task response
        if (response.task_id) {
            log(`Task started: ${response.message}`, 'info');
            showNotification('Задача запущена, ожидайте...', 'info');
            
            // Start polling for task status
            await pollTaskStatus(response.task_id);
            return;
        }
        
        // Synchronous response
        if (response.success) {
            log(`Command executed successfully`, 'success');
            if (response.stdout) log(response.stdout);
            showNotification('Операция выполнена', 'success');
        } else {
            log(`Command failed (exit code: ${response.exit_code || 'unknown'})`, 'error');
            if (response.stdout) log(response.stdout, 'warn');
            if (response.stderr) log(response.stderr, 'error');
            showNotification('Ошибка выполнения команды', 'error');
        }
        
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
        showNotification('Ошибка выполнения команды', 'error');
    }
}

// Poll for async task status
async function pollTaskStatus(taskId, interval = 2000) {
    const maxAttempts = 150; // 5 minutes max (150 * 2s)
    let attempts = 0;
    
    while (attempts < maxAttempts) {
        attempts++;
        
        try {
            const response = await api.get(`/tasks/${taskId}`);
            
            if (response.status === 'PENDING') {
                log(`Waiting for task to start...`, 'info');
            } else if (response.status === 'STARTED' || response.status === 'PROGRESS') {
                if (response.progress) {
                    log(response.progress, 'info');
                }
            } else if (response.status === 'SUCCESS') {
                // Task completed successfully
                const result = response.result;
                if (result) {
                    if (result.success) {
                        log(`Task completed successfully`, 'success');
                        if (result.stdout) log(result.stdout);
                        showNotification('Операция выполнена', 'success');
                    } else {
                        log(`Task failed (exit code: ${result.exit_code || 'unknown'})`, 'error');
                        if (result.stdout) log(result.stdout, 'warn');
                        if (result.stderr) log(result.stderr, 'error');
                        showNotification('Ошибка выполнения команды', 'error');
                    }
                }
                return; // Done
            } else if (response.status === 'FAILURE') {
                log(`Task failed: ${response.error || 'Unknown error'}`, 'error');
                showNotification('Ошибка выполнения задачи', 'error');
                return; // Done
            } else if (response.status === 'REVOKED') {
                log(`Task was cancelled`, 'warn');
                showNotification('Задача отменена', 'warning');
                return; // Done
            }
            
            // Wait before next poll
            await new Promise(resolve => setTimeout(resolve, interval));
            
        } catch (error) {
            log(`Error checking task status: ${error.message}`, 'error');
            // Continue polling despite errors
            await new Promise(resolve => setTimeout(resolve, interval));
        }
    }
    
    log(`Task polling timeout after ${maxAttempts * interval / 1000} seconds`, 'warn');
    showNotification('Превышено время ожидания', 'warning');
}

// async function mockRunAction(action) { ... } (removed)

async function installAll() {
    if (!confirm('Это запустит полную установку всех компонентов на ноде. Продолжить?\n\nПорядок: System → Nginx → Certbot → Python → Agent')) return;
    
    switchTab('logs');
    log('═══════════════════════════════════════════', 'info');
    log('Начало полной установки edge node', 'info');
    log('═══════════════════════════════════════════', 'info');
    
    // Correct order: system deps first, then nginx, certbot, python env, and finally agent
    const steps = [
        { action: 'install_deps', name: 'System Dependencies' },
        { action: 'install_nginx', name: 'Nginx Web Server' },
        { action: 'install_certbot', name: 'Certbot SSL' },
        { action: 'install_python', name: 'Python Environment' },
        { action: 'install_agent', name: 'Edge Agent' }
    ];
    
    let success = true;
    for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        log(``, 'normal');
        log(`[${i + 1}/${steps.length}] Устанавливаю: ${step.name}...`, 'info');
        
        try {
            await runAction(step.action);
        } catch (error) {
            log(`Ошибка при установке ${step.name}: ${error.message}`, 'error');
            success = false;
            if (!confirm(`Произошла ошибка при установке ${step.name}. Продолжить с остальными компонентами?`)) {
                break;
            }
        }
    }
    
    log(``, 'normal');
    log('═══════════════════════════════════════════', 'info');
    if (success) {
        log('✓ Все компоненты установлены успешно!', 'success');
        log('Нода готова к работе.', 'success');
    } else {
        log('⚠ Установка завершена с ошибками', 'error');
        log('Проверьте логи выше и исправьте проблемы.', 'error');
    }
    log('═══════════════════════════════════════════', 'info');
    
    // Refresh component statuses
    checkAllComponents();
}

async function checkConnection() {
    showNotification('Проверка соединения...', 'info');
    try {
        const response = await api.post(`/edge-nodes/${NODE_ID}/health-check`);
        if (response.status === 'online') {
            showNotification('Связь с нодой установлена', 'success');
            // Update UI status badge
            const badge = document.querySelector('.badge');
            if (badge) {
                badge.className = 'badge badge-success';
                badge.innerText = 'online';
            }
        } else {
             showNotification(`Связь отсутствует: ${response.error || 'Unknown error'}`, 'error');
             const badge = document.querySelector('.badge');
             if (badge) {
                badge.className = 'badge badge-error';
                badge.innerText = 'offline';
            }
        }
    } catch (error) {
        showNotification(`Ошибка связи: ${error.message}`, 'error');
    }
}

async function updateComponentStatus(component, cardId) {
    const card = document.getElementById(cardId);
    if (!card) return;
    
    const dot = card.querySelector('.status-dot');
    const text = card.querySelector('.status-text');
    
    try {
        const response = await api.get(`/edge-nodes/${NODE_ID}/component/${component}`);
        
        // Update dot
        dot.className = 'status-dot';
        if (response.running) {
            dot.classList.add('status-success');
        } else if (response.installed) {
             dot.classList.add('status-warning'); // Installed but stopped
        } else {
             dot.classList.add('status-error'); // Not installed or error
        }
        
        // Update text
        let statusStr = response.status_text || (response.running ? 'Active' : 'Inactive');
        if (response.version) statusStr += ` (${response.version})`;
        
        text.innerText = statusStr;
        text.style.color = response.running ? 'var(--success)' : 'var(--text-muted)';
        
    } catch (error) {
        dot.className = 'status-dot status-error';
        text.innerText = 'Error checking status';
    }
}

async function checkAllComponents() {
    const components = [
        { id: 'system', card: 'card-system' },
        { id: 'nginx', card: 'card-nginx' },
        { id: 'python', card: 'card-python' },
        { id: 'agent', card: 'card-agent' },
        { id: 'certbot', card: 'card-certbot' }
    ];
    
    for (const comp of components) {
        updateComponentStatus(comp.id, comp.card);
    }
}

// Check components on load and when tab is switched
document.addEventListener('DOMContentLoaded', () => {
    // Optional: check immediately if tab is active
    if (document.getElementById('tab-components').style.display !== 'none') {
        checkAllComponents();
    }
});

const originalSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
    // Re-implementing switchTab logic
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    const btn = Array.from(document.querySelectorAll('.tab-link')).find(b => b.onclick.toString().includes(tabName));
    if (btn) btn.classList.add('active');
    
    if (tabName === 'components') {
        checkAllComponents();
    } else if (tabName === 'nginx') {
        loadNginxRules();
    }
}
</script>
{% endblock %}

