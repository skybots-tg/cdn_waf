{% extends "base.html" %}

{% block title %}{{ domain.name }} - DNS - FlareCloud{% endblock %}

{% block content %}
<div class="container" style="margin-top: 40px;">
    <!-- Domain Header -->
    <div class="glass-card mb-4">
        <div class="flex-between">
            <div>
                <h1><i class="fas fa-globe"></i> {{ domain.name }}</h1>
                <div class="flex gap-2 mt-2">
                    <span class="badge badge-success">
                        <i class="fas fa-check-circle"></i> Active
                    </span>
                    <span class="badge badge-orange">
                        <i class="fas fa-cloud"></i> Proxied
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="/domains/{{ domain.id }}/dns" class="btn btn-primary">DNS</a>
                <a href="/domains/{{ domain.id }}/waf" class="btn btn-secondary">WAF</a>
                <a href="/domains/{{ domain.id }}/settings" class="btn btn-secondary">Settings</a>
                <a href="/domains/{{ domain.id }}/analytics" class="btn btn-secondary">Analytics</a>
            </div>
        </div>
    </div>
    
    <!-- Nameservers Info -->
    <div class="glass-card mb-4">
        <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
            <i class="fas fa-server"></i> Cloud Nameservers
        </h2>
        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
            Ensure your domain at your registrar points to these nameservers:
        </p>
        
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--border-radius-sm);">
            {% if dns_nodes %}
                {% for node_hostname in dns_nodes %}
                <div style="display: flex; align-items: center; gap: 12px; {% if not loop.last %}margin-bottom: 12px;{% endif %}">
                    <code style="font-size: 16px; font-weight: 600; color: var(--accent-primary);">{{ node_hostname }}</code>
                    <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('{{ node_hostname }}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="color: var(--text-secondary);">No DNS nodes configured yet.</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- DNS Records -->
    <div class="glass-card">
        <div class="flex-between mb-3">
            <h2><i class="fas fa-network-wired"></i> DNS Records</h2>
            <button class="btn btn-primary" onclick="showAddRecordModal()">
                <i class="fas fa-plus"></i> Add Record
            </button>
        </div>
        
        <div class="table-container">
            <table class="table" id="dns-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Content</th>
                        <th>TTL</th>
                        <th>Status</th>
                        <th>SSL</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Records will be loaded here -->
                    <tr>
                        <td colspan="6" class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading records...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Add Record Modal -->
    <div id="add-record-modal" class="modal">
        <div class="modal-content glass-card">
            <div class="flex-between mb-3">
                <h3 style="margin: 0;" id="modal-title">Add DNS Record</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeAddRecordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-record-form" onsubmit="handleCreateRecord(event)">
                <input type="hidden" id="record-id">
                <div class="grid grid-2 mb-3">
                    <div class="form-group mb-0">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="record-type" onchange="handleTypeChange()">
                        <option value="A">A</option>
                        <option value="AAAA">AAAA</option>
                        <option value="CNAME">CNAME</option>
                        <option value="MX">MX</option>
                        <option value="TXT">TXT</option>
                        <option value="NS">NS</option>
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">TTL</label>
                    <select class="form-select" id="record-ttl">
                        <option value="1">Auto</option>
                        <option value="60">1 min</option>
                        <option value="300">5 min</option>
                        <option value="1800">30 min</option>
                        <option value="3600">1 hour</option>
                        <option value="86400">1 day</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Name</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="text" class="form-input" id="record-name" placeholder="@" required>
                    <span style="color: var(--text-secondary); font-size: 14px;">.{{ domain.name }}</span>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    Use @ for root
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Content</label>
                <input type="text" class="form-input" id="record-content" placeholder="192.0.2.1" required>
            </div>

            <div class="form-group" id="priority-group" style="display: none;">
                <label class="form-label">Priority</label>
                <input type="number" class="form-input" id="record-priority" placeholder="10" min="0" max="65535">
            </div>

            <div class="glass-card-sm bg-tertiary mb-4">
                <div class="flex-between">
                    <div>
                        <div class="flex gap-2" style="align-items: center;">
                            <span style="font-weight: 600;">Proxy Status</span>
                            <span class="badge badge-orange" id="proxy-badge">
                                <i class="fas fa-cloud"></i> Proxied
                            </span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="proxy-desc">
                            Traffic is proxied through our global network
                        </p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="record-proxied" checked onchange="toggleProxyState()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="flex gap-2" style="justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeAddRecordModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="btn-save-record">
                    <i class="fas fa-save"></i> Save Record
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.modal.active {
    opacity: 1;
    pointer-events: auto;
}

.modal-content {
    width: 100%;
    max-width: 500px;
    transform: translateY(20px);
    transition: transform 0.3s ease;
    margin: 20px;
}

.modal.active .modal-content {
    transform: translateY(0);
}

.bg-tertiary {
    background: var(--bg-tertiary);
}
</style>

<script>
    const domainId = {{ domain.id }};
    const domainName = "{{ domain.name }}";
    
    document.addEventListener('DOMContentLoaded', () => {
        loadDNSRecords(domainId);
        handleTypeChange(); // Initialize form state
    });
    
    function showAddRecordModal() {
        document.getElementById('add-record-modal').classList.add('active');
        document.getElementById('record-name').focus();
        
        // Reset to Add mode
        document.getElementById('modal-title').textContent = 'Add DNS Record';
        document.getElementById('btn-save-record').innerHTML = '<i class="fas fa-save"></i> Save Record';
        document.getElementById('record-id').value = '';
        
        // Set default values for new record
        document.getElementById('record-proxied').checked = true;
        updateProxyVisuals(true);
    }
    
    function closeAddRecordModal() {
        document.getElementById('add-record-modal').classList.remove('active');
        document.getElementById('add-record-form').reset();
        document.getElementById('record-id').value = '';
        handleTypeChange();
    }
    
    // Close modal on click outside
    document.getElementById('add-record-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('add-record-modal')) {
            closeAddRecordModal();
        }
    });

    function handleTypeChange() {
        const type = document.getElementById('record-type').value;
        const priorityGroup = document.getElementById('priority-group');
        const proxySwitch = document.getElementById('record-proxied');
        const proxyBadge = document.getElementById('proxy-badge');
        
        // Show/hide priority for MX
        if (type === 'MX') {
            priorityGroup.style.display = 'block';
            document.getElementById('record-priority').required = true;
        } else {
            priorityGroup.style.display = 'none';
            document.getElementById('record-priority').required = false;
        }

        // Handle proxy availability
        const canProxy = ['A', 'AAAA', 'CNAME'].includes(type);
        proxySwitch.disabled = !canProxy;
        
        if (!canProxy) {
            proxySwitch.checked = false;
            updateProxyVisuals(false);
        } else {
            // Just update visuals based on current checkbox state
            updateProxyVisuals(proxySwitch.checked);
        }
    }

    function toggleProxyState() {
        const isChecked = document.getElementById('record-proxied').checked;
        updateProxyVisuals(isChecked);
    }

    function updateProxyVisuals(isProxied) {
        const badge = document.getElementById('proxy-badge');
        const desc = document.getElementById('proxy-desc');
        
        if (isProxied) {
            badge.className = 'badge badge-orange';
            badge.innerHTML = '<i class="fas fa-cloud"></i> Proxied';
            desc.textContent = 'Traffic is proxied through our global network';
        } else {
            badge.className = 'badge';
            badge.style.background = 'var(--bg-tertiary)';
            badge.style.color = 'var(--text-muted)';
            badge.innerHTML = '<i class="fas fa-globe"></i> DNS Only';
            desc.textContent = 'Traffic bypasses the CDN and goes directly to origin';
        }
    }
    
    async function editRecord(recordId) {
        try {
            // Fetch record details
            const record = await api.get(`/dns/records/${recordId}`);
            
            // Populate form
            document.getElementById('record-id').value = record.id;
            document.getElementById('record-type').value = record.type;
            
            // Handle name (@ or subdomain)
            let displayName = record.name;
            if (displayName === '@') {
                // leave as @ or empty? Placeholder says @. 
                // Logic in backend normalizes it. 
                // Let's keep it as is from backend.
            } 
            document.getElementById('record-name').value = displayName;
            
            document.getElementById('record-content').value = record.content;
            document.getElementById('record-ttl').value = record.ttl;
            
            // Handle priority
            if (record.priority !== null) {
                document.getElementById('record-priority').value = record.priority;
            }
            
            // Handle proxied - set BEFORE calling handleTypeChange()
            document.getElementById('record-proxied').checked = record.proxied;
            
            // Update visuals - this will now respect the checkbox value we just set
            handleTypeChange();
            updateProxyVisuals(record.proxied);
            
            // Set modal to Edit mode
            document.getElementById('modal-title').textContent = 'Edit DNS Record';
            document.getElementById('btn-save-record').innerHTML = '<i class="fas fa-save"></i> Update Record';
            
            // Show modal
            document.getElementById('add-record-modal').classList.add('active');
            
        } catch (error) {
            console.error('Error fetching record:', error);
            showNotification('Failed to load record details', 'error');
        }
    }
    
    async function handleCreateRecord(e) {
        e.preventDefault();
        
        const btn = document.getElementById('btn-save-record');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        try {
            const recordId = document.getElementById('record-id').value;
            const type = document.getElementById('record-type').value;
            const name = document.getElementById('record-name').value.trim();
            const content = document.getElementById('record-content').value.trim();
            const ttl = parseInt(document.getElementById('record-ttl').value);
            const proxied = document.getElementById('record-proxied').checked;
            const priority = document.getElementById('record-priority').value;

            // Normalize name
            let finalName = name;
            if (name === '@' || name === '') {
                finalName = '@';
            }

            const data = {
                type,
                name: finalName,
                content,
                ttl: ttl === 1 ? 3600 : ttl, // Default to 1 hour if Auto
                proxied: ['A', 'AAAA', 'CNAME'].includes(type) ? proxied : false
            };

            if (type === 'MX' && priority) {
                data.priority = parseInt(priority);
            }

            if (recordId) {
                // Update existing record
                await api.patch(`/dns/records/${recordId}`, data);
                showNotification('DNS record updated successfully', 'success');
            } else {
                // Create new record
                await api.post(`/dns/domains/${domainId}/records`, data);
                showNotification('DNS record created successfully', 'success');
            }
            
            closeAddRecordModal();
            loadDNSRecords(domainId);
        } catch (error) {
            console.error('Error saving record:', error);
            showNotification(error.message || 'Failed to save record', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function deleteRecord(recordId) {
        if (!confirm('Are you sure you want to delete this record?')) return;
        
        try {
            await api.delete(`/dns/records/${recordId}`);
            showNotification('Record deleted successfully', 'success');
            loadDNSRecords(domainId);
        } catch (error) {
            showNotification(error.message, 'error');
        }
    }
    
    async function issueCertificate(subdomain) {
        const fqdn = subdomain === '@' ? domainName : `${subdomain}.${domainName}`;
        if (!confirm(`Issue Let's Encrypt certificate for ${fqdn}?`)) return;
        
        try {
            // Use the new endpoint that issues certificate for specific subdomain
            const response = await fetch(`/api/v1/domains/${domainId}/certificates/issue?subdomain=${encodeURIComponent(subdomain)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to issue certificate');
            }
            
            const data = await response.json();
            showNotification(`Certificate issuance started for ${data.fqdn}`, 'success');
            
            // Reload after 5 seconds
            setTimeout(() => {
                loadDNSRecords(domainId);
            }, 5000);
        } catch (error) {
            showNotification(error.message || 'Failed to issue certificate', 'error');
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
        });
    }
</script>
{% endblock %}
