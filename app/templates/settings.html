{% extends "base.html" %}

{% block title %}Settings - FlareCloud{% endblock %}

{% block content %}
<div class="container" style="padding: 32px 24px; max-width: 1200px;">
    <!-- Header -->
    <div class="mb-4">
        <h1 style="font-size: 32px; font-weight: 700;">Settings</h1>
        <p style="color: var(--text-secondary); font-size: 14px;">
            Manage your account, organization, and preferences
        </p>
    </div>

    <!-- Settings Tabs -->
    <div class="tabs mb-4">
        <button class="tab-link active" onclick="showSettingsTab('account')">
            <i class="fas fa-user"></i> Account
        </button>
        <button class="tab-link" onclick="showSettingsTab('organization')">
            <i class="fas fa-users"></i> Organization
        </button>
        <button class="tab-link" onclick="showSettingsTab('api')">
            <i class="fas fa-key"></i> API Keys
        </button>
        <button class="tab-link" onclick="showSettingsTab('security')">
            <i class="fas fa-shield-alt"></i> Security
        </button>
        <button class="tab-link" onclick="showSettingsTab('notifications')">
            <i class="fas fa-bell"></i> Notifications
        </button>
    </div>

    <!-- Account Tab -->
    <div id="tab-account" class="settings-tab-content">
        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Profile Information</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="email" value="{{ user.email }}" readonly>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                        Contact support to change your email address
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="full-name" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="company" placeholder="Acme Inc.">
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Profile
                </button>
            </form>
        </div>

        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Change Password</h2>
            <form id="password-form">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" id="current-password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="new-password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirm-password" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-lock"></i> Update Password
                </button>
            </form>
        </div>

        <div class="glass-card">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--error);">
                <i class="fas fa-exclamation-triangle"></i> Danger Zone
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Once you delete your account, there is no going back. Please be certain.
            </p>
            <button class="btn btn-error" onclick="confirmDeleteAccount()">
                <i class="fas fa-trash"></i> Delete Account
            </button>
        </div>
    </div>

    <!-- Organization Tab -->
    <div id="tab-organization" class="settings-tab-content" style="display: none;">
        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">Organization Details</h2>
            <form id="organization-form">
                <div class="form-group">
                    <label class="form-label">Organization Name</label>
                    <input type="text" class="form-input" id="org-name" placeholder="My Organization">
                </div>
                <div class="form-group">
                    <label class="form-label">Organization ID</label>
                    <input type="text" class="form-input" id="org-id" value="org_12345" readonly>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Organization
                </button>
            </form>
        </div>

        <div class="glass-card mb-3">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">Team Members</h2>
                <button class="btn btn-primary btn-sm" onclick="showInviteMemberModal()">
                    <i class="fas fa-user-plus"></i> Invite Member
                </button>
            </div>
            <div id="team-members">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="glass-card">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                <i class="fas fa-chart-bar"></i> Usage & Billing
            </h2>
            <div class="grid grid-3 gap-3 mb-3">
                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--border-radius-sm);">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Current Plan</div>
                    <div style="font-size: 20px; font-weight: 600;">Free</div>
                </div>
                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--border-radius-sm);">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Domains</div>
                    <div style="font-size: 20px; font-weight: 600;">0 / 3</div>
                </div>
                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--border-radius-sm);">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Bandwidth</div>
                    <div style="font-size: 20px; font-weight: 600;">0 GB / 10 GB</div>
                </div>
            </div>
            <button class="btn btn-primary">
                <i class="fas fa-arrow-up"></i> Upgrade Plan
            </button>
        </div>
    </div>

    <!-- API Keys Tab -->
    <div id="tab-api" class="settings-tab-content" style="display: none;">
        <div class="glass-card mb-3">
            <div class="flex-between mb-3">
                <div>
                    <h2 style="font-size: 20px; font-weight: 600;">API Keys</h2>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">
                        Manage API keys for programmatic access to your CDN
                    </p>
                </div>
                <button class="btn btn-primary btn-sm" onclick="showCreateAPIKeyModal()">
                    <i class="fas fa-plus"></i> Create API Key
                </button>
            </div>
            <div id="api-keys-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="glass-card">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">
                <i class="fas fa-book"></i> API Documentation
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Learn how to use the FlareCloud API to automate your infrastructure.
            </p>
            <a href="/docs" target="_blank" class="btn btn-secondary">
                <i class="fas fa-book-open"></i> View API Docs (Swagger)
            </a>
            <a href="/redoc" target="_blank" class="btn btn-secondary" style="margin-left: 8px;">
                <i class="fas fa-file-alt"></i> View API Docs (ReDoc)
            </a>
        </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="settings-tab-content" style="display: none;">
        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                Two-Factor Authentication
            </h2>
            <div class="flex-between">
                <div>
                    <p style="color: var(--text-secondary); margin-bottom: 8px;">
                        Add an extra layer of security to your account
                    </p>
                    <div id="2fa-status">
                        <span class="badge badge-secondary">Disabled</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="enable2FA()">
                    <i class="fas fa-shield-alt"></i> Enable 2FA
                </button>
            </div>
        </div>

        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                Active Sessions
            </h2>
            <div id="active-sessions">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="glass-card">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                Security Log
            </h2>
            <div id="security-log">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>
    </div>

    <!-- Notifications Tab -->
    <div id="tab-notifications" class="settings-tab-content" style="display: none;">
        <div class="glass-card mb-3">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                Email Notifications
            </h2>
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">Security Alerts</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Get notified about suspicious activity and security events
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notify-security" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">Downtime Alerts</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Receive alerts when your sites are down or experiencing issues
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notify-downtime">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">SSL Certificate Expiry</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Get reminders before your SSL certificates expire
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notify-ssl">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">Usage & Quota Warnings</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Alerts when approaching bandwidth or request limits
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notify-usage">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 4px;">Weekly Reports</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            Receive weekly summary of your traffic and performance
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notify-weekly">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveNotificationSettings()">
                <i class="fas fa-save"></i> Save Preferences
            </button>
        </div>

        <div class="glass-card">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">
                Webhook Notifications
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Send notifications to external services via webhooks (Slack, Discord, etc.)
            </p>
            <button class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Webhook
            </button>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--glass-border);
    padding-bottom: 4px;
    flex-wrap: wrap;
}

.tab-link {
    padding: 12px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
    transition: all var(--transition-fast);
    font-weight: 500;
    background: none;
    border: none;
    cursor: pointer;
}

.tab-link:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.tab-link.active {
    color: var(--accent-primary);
    background: var(--accent-light);
    border-bottom: 2px solid var(--accent-primary);
}

.settings-tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
function showSettingsTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.settings-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-link').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    
    // Add active class to button
    event.target.classList.add('active');
    
    // Load tab data
    loadTabData(tabName);
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'organization':
            loadTeamMembers();
            break;
        case 'api':
            loadAPIKeys();
            break;
        case 'security':
            loadActiveSessions();
            loadSecurityLog();
            break;
    }
}

async function loadTeamMembers() {
    try {
        const response = await fetch('/api/v1/organization/members');
        const data = await response.json();
        
        const container = document.getElementById('team-members');
        
        if (data.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 24px;">No team members yet</p>';
            return;
        }
        
        container.innerHTML = data.map(member => `
            <div class="glass-card-sm mb-2">
                <div class="flex-between">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${member.email}</div>
                        <span class="badge badge-primary">${member.role}</span>
                    </div>
                    ${member.role !== 'owner' ? `
                        <button class="btn btn-error btn-sm" onclick="removeMember(${member.id})">
                            <i class="fas fa-user-minus"></i> Remove
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading team members:', error);
    }
}

async function loadAPIKeys() {
    try {
        const response = await fetch('/api/v1/auth/api-keys');
        const data = await response.json();
        
        const container = document.getElementById('api-keys-list');
        
        if (data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-key" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>No API keys created yet</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = data.map(key => `
            <div class="glass-card-sm mb-2">
                <div class="flex-between">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${key.name}</div>
                        <div style="font-size: 13px; color: var(--text-secondary); font-family: monospace;">
                            ${key.key_preview}...
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                            Created: ${new Date(key.created_at).toLocaleDateString()}
                        </div>
                    </div>
                    <button class="btn btn-error btn-sm" onclick="deleteAPIKey('${key.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading API keys:', error);
    }
}

async function loadActiveSessions() {
    // TODO: Implement
    document.getElementById('active-sessions').innerHTML = `
        <div class="glass-card-sm">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <i class="fas fa-desktop" style="color: var(--info);"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 600;">Current Session</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">Windows · Chrome · 192.168.1.1</div>
                </div>
                <span class="badge badge-success">Active</span>
            </div>
        </div>
    `;
}

async function loadSecurityLog() {
    // TODO: Implement
    document.getElementById('security-log').innerHTML = `
        <p style="text-align: center; color: var(--text-muted); padding: 24px;">No recent security events</p>
    `;
}

function saveNotificationSettings() {
    showNotification('Notification preferences saved', 'success');
}

function confirmDeleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        showNotification('Account deletion initiated. You will receive a confirmation email.', 'warning');
    }
}

function enable2FA() {
    showNotification('2FA setup coming soon', 'info');
}

// ==================== API Keys ====================

function showCreateAPIKeyModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Create API Key</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Key Name *</label>
                    <input type="text" class="form-input" id="api-key-name" 
                           placeholder="e.g., Production Server" required>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                        A descriptive name to identify this key
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Expiration (optional)</label>
                    <select class="form-input" id="api-key-expires">
                        <option value="">Never expires</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                        <option value="365">1 year</option>
                    </select>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                        <i class="fas fa-info-circle"></i> The API key will only be shown once after creation.
                        Make sure to copy and store it securely.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createAPIKey()">
                    <i class="fas fa-plus"></i> Create Key
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    // Focus input
    setTimeout(() => document.getElementById('api-key-name').focus(), 100);
}

async function createAPIKey() {
    const name = document.getElementById('api-key-name').value.trim();
    const expiresDays = document.getElementById('api-key-expires').value;
    
    if (!name) {
        showNotification('Please enter a key name', 'warning');
        return;
    }
    
    try {
        const body = { name };
        if (expiresDays) {
            const expiresAt = new Date();
            expiresAt.setDate(expiresAt.getDate() + parseInt(expiresDays));
            body.expires_at = expiresAt.toISOString();
        }
        
        const response = await fetch('/api/v1/auth/api-keys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(body)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create API key');
        }
        
        const result = await response.json();
        closeModal();
        
        // Show the key in a modal (only shown once!)
        showNewAPIKeyModal(result);
        
    } catch (error) {
        showNotification(error.message || 'Failed to create API key', 'error');
        console.error(error);
    }
}

function showNewAPIKeyModal(keyData) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> API Key Created</h3>
            </div>
            <div class="modal-body">
                <div style="background: var(--warning-bg, rgba(234, 179, 8, 0.1)); padding: 16px; border-radius: 8px; border: 1px solid var(--warning); margin-bottom: 16px;">
                    <p style="font-size: 14px; color: var(--warning); margin: 0; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> Important: Copy this key now!
                    </p>
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 0 0;">
                        This is the only time you'll see this key. Store it securely.
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your API Key</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="new-api-key-value" 
                               value="${keyData.token}" readonly 
                               style="font-family: monospace; font-size: 13px;">
                        <button class="btn btn-secondary" onclick="copyAPIKey()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                        <strong>Usage:</strong> Include this key in the Authorization header:
                    </p>
                    <code style="display: block; margin-top: 8px; padding: 8px; background: var(--bg-primary); border-radius: 4px; font-size: 12px;">
                        Authorization: Bearer ${keyData.token.substring(0, 20)}...
                    </code>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal(); loadAPIKeys();">
                    <i class="fas fa-check"></i> Done, I've Copied the Key
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function copyAPIKey() {
    const keyInput = document.getElementById('new-api-key-value');
    keyInput.select();
    navigator.clipboard.writeText(keyInput.value).then(() => {
        showNotification('API key copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        showNotification('API key copied to clipboard!', 'success');
    });
}

async function deleteAPIKey(keyId) {
    if (!confirm('Are you sure you want to delete this API key? Any applications using it will stop working.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/auth/api-keys/${keyId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${getToken()}`
            }
        });
        
        if (!response.ok && response.status !== 204) {
            throw new Error('Failed to delete API key');
        }
        
        showNotification('API key deleted', 'success');
        loadAPIKeys();
    } catch (error) {
        showNotification('Failed to delete API key', 'error');
        console.error(error);
    }
}

// ==================== Organization ====================

function showInviteMemberModal() {
    showNotification('Team invitations coming soon', 'info');
}

async function removeMember(memberId) {
    if (!confirm('Are you sure you want to remove this team member?')) {
        return;
    }
    
    showNotification('Member removal not yet implemented', 'info');
}

// ==================== Utilities ====================

function closeModal() {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => modal.remove());
}

function getToken() {
    return localStorage.getItem('access_token') || localStorage.getItem('auth_token') || '';
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Load initial data
    loadTabData('account');
    
    // Form handlers
    document.getElementById('profile-form').addEventListener('submit', (e) => {
        e.preventDefault();
        showNotification('Profile updated successfully', 'success');
    });
    
    document.getElementById('password-form').addEventListener('submit', (e) => {
        e.preventDefault();
        showNotification('Password updated successfully', 'success');
    });
    
    document.getElementById('organization-form').addEventListener('submit', (e) => {
        e.preventDefault();
        showNotification('Organization updated successfully', 'success');
    });
});
</script>
{% endblock %}
