{% extends "base.html" %}

{% block title %}{{ domain.name }} - Settings - FlareCloud{% endblock %}

{% block content %}
<div class="container" style="padding: 32px 24px;">
    <!-- Domain Header -->
    <div class="glass-card mb-4">
        <div class="flex-between">
            <div>
                <h1><i class="fas fa-globe"></i> {{ domain.name }}</h1>
                <div class="flex gap-2 mt-2">
                    <span class="badge badge-success">
                        <i class="fas fa-check-circle"></i> Active
                    </span>
                    <span class="badge badge-orange">
                        <i class="fas fa-cloud"></i> Proxied
                    </span>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="/domains/{{ domain.id }}/dns" class="btn btn-secondary">DNS</a>
                <a href="/domains/{{ domain.id }}/waf" class="btn btn-secondary">WAF</a>
                <a href="/domains/{{ domain.id }}/settings" class="btn btn-primary">Settings</a>
                <a href="/domains/{{ domain.id }}/analytics" class="btn btn-secondary">Analytics</a>
            </div>
        </div>
    </div>

    <!-- Sub-tabs -->
    <div class="sub-tabs mb-4">
        <button class="sub-tab-btn active" onclick="showTab('cdn')">
            <i class="fas fa-server"></i> CDN & Cache
        </button>
        <button class="sub-tab-btn" onclick="showTab('origins')">
            <i class="fas fa-network-wired"></i> Origins
        </button>
        <button class="sub-tab-btn" onclick="showTab('ssl')">
            <i class="fas fa-lock"></i> SSL/TLS
        </button>
        <button class="sub-tab-btn" onclick="showTab('security')">
            <i class="fas fa-shield-alt"></i> Security
        </button>
    </div>

    <!-- CDN Tab -->
    <div id="tab-cdn" class="tab-content">
        <div class="glass-card mb-3">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">Cache Rules</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddCacheRuleModal()">
                    <i class="fas fa-plus"></i> Add Rule
                </button>
            </div>
            
            <div id="cache-rules-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="grid grid-2 gap-3">
            <div class="glass-card">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                    <i class="fas fa-broom"></i> Cache Purge
                </h3>
                <div class="form-group">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="purgeCache('all')">
                        <i class="fas fa-trash-alt"></i> Purge Everything
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Purge by URL</label>
                    <input type="text" class="form-input" id="purge-url" placeholder="/path/to/file.css">
                    <button class="btn btn-secondary mt-1" style="width: 100%;" onclick="purgeCache('url')">
                        Purge URL
                    </button>
                </div>
            </div>

            <div class="glass-card">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                    <i class="fas fa-bug"></i> Dev Mode
                </h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Temporarily bypass cache for testing (10 minutes)
                </p>
                <div id="dev-mode-status">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="toggleDevMode()">
                        <i class="fas fa-play"></i> Enable Dev Mode
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Origins Tab -->
    <div id="tab-origins" class="tab-content" style="display: none;">
        <div class="glass-card">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">Origin Servers</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddOriginModal()">
                    <i class="fas fa-plus"></i> Add Origin
                </button>
            </div>
            
            <div id="origins-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>
    </div>

    <!-- SSL Tab -->
    <div id="tab-ssl" class="tab-content" style="display: none;">
        <div class="grid grid-2 gap-3 mb-3">
            <div class="glass-card">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                    TLS Mode
                </h3>
                <select class="form-select" id="tls-mode">
                    <option value="flexible">Flexible</option>
                    <option value="full">Full</option>
                    <option value="strict">Strict</option>
                </select>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                    Controls how TLS connections are made to origin
                </p>
            </div>

            <div class="glass-card">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                    Force HTTPS
                </h3>
                <label class="toggle-switch">
                    <input type="checkbox" id="force-https">
                    <span class="toggle-slider"></span>
                </label>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                    Automatically redirect HTTP to HTTPS
                </p>
            </div>
        </div>

        <div class="glass-card mb-3">
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                HSTS Settings
            </h3>
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="hsts-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="form-label" style="margin: 0;">Enable HSTS</span>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Max Age (seconds)</label>
                <input type="number" class="form-input" id="hsts-max-age" value="31536000">
            </div>
            <button class="btn btn-primary" onclick="saveTLSSettings()">
                <i class="fas fa-save"></i> Save TLS Settings
            </button>
        </div>

        <div class="glass-card mb-3">
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">
                <i class="fas fa-envelope"></i> ACME Settings
            </h3>
            <div class="form-group">
                <label class="form-label">Default Email for Certificate Notifications</label>
                <input type="email" class="form-input" id="acme-default-email" 
                       placeholder="your@email.com">
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                    This email will be used for Let's Encrypt notifications (expiry warnings, etc.)
                </p>
            </div>
            <button class="btn btn-primary" onclick="saveACMESettings()">
                <i class="fas fa-save"></i> Save ACME Settings
            </button>
        </div>

        <div class="glass-card">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">SSL Certificates</h2>
                <div class="flex gap-2">
                    <button class="btn btn-primary btn-sm" onclick="showUploadCertModal()">
                        <i class="fas fa-upload"></i> Upload Certificate
                    </button>
                </div>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <p style="font-size: 13px; color: var(--text-secondary); margin: 0;">
                    <i class="fas fa-info-circle"></i> 
                    Certificates are automatically available for all proxied DNS A records. 
                    Click "Issue" to request a free Let's Encrypt certificate for any subdomain.
                </p>
            </div>
            
            <div id="certificates-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="tab-content" style="display: none;">
        <div class="glass-card mb-3">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">
                    <i class="fas fa-shield-alt"></i> WAF Rules
                </h2>
                <button class="btn btn-primary btn-sm" onclick="showAddWAFRuleModal()">
                    <i class="fas fa-plus"></i> Add Rule
                </button>
            </div>
            <div id="waf-rules-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="glass-card mb-3">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">
                    <i class="fas fa-tachometer-alt"></i> Rate Limiting
                </h2>
                <button class="btn btn-primary btn-sm" onclick="showAddRateLimitModal()">
                    <i class="fas fa-plus"></i> Add Limit
                </button>
            </div>
            <div id="rate-limits-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>

        <div class="glass-card">
            <div class="flex-between mb-3">
                <h2 style="font-size: 20px; font-weight: 600;">
                    <i class="fas fa-ban"></i> IP Access Control
                </h2>
                <button class="btn btn-primary btn-sm" onclick="showAddIPRuleModal()">
                    <i class="fas fa-plus"></i> Add Rule
                </button>
            </div>
            <div id="ip-rules-list">
                <p style="text-align: center; color: var(--text-muted); padding: 32px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </p>
            </div>
        </div>
    </div>
</div>

<style>
.tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--glass-border);
    padding-bottom: 4px;
}

.tab-link {
    padding: 12px 20px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
    transition: all var(--transition-fast);
    font-weight: 500;
}

.tab-link:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
}

.tab-link.active {
    color: var(--accent-primary);
    background: var(--accent-light);
    border-bottom: 2px solid var(--accent-primary);
}

.sub-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.sub-tab-btn {
    padding: 10px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius-sm);
    color: var(--text-primary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.sub-tab-btn:hover {
    background: var(--bg-secondary);
    border-color: var(--accent-primary);
}

.sub-tab-btn.active {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}

.tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script src="/static/js/domain_settings.js?v=3"></script>

<script>
const DOMAIN_ID = {{ domain.id }};

function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    
    // Add active class to button
    event.target.classList.add('active');
    
    // Load tab data
    loadTabData(tabName);
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'cdn':
            loadCacheRules();
            loadDevModeStatus();
            break;
        case 'origins':
            loadOrigins();
            break;
        case 'ssl':
            loadTLSSettings();
            loadCertificates();
            loadACMESettings();
            break;
        case 'security':
            loadWAFRules();
            loadRateLimits();
            loadIPRules();
            break;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadTabData('cdn');
});
</script>
{% endblock %}
